name: Create Release

on:
  push:
    tags:
      - 'v*.*.*' # Se dÃ©clenche sur les tags comme v1.0.0

jobs:
  # --- Job pour compiler sur Linux ---
  build-linux:
    name: Build for Linux (x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Build release binary
        run: cargo build --release --workspace --bin fish_11_cli --target x86_64-unknown-linux-gnu

      - name: Prepare release artifacts
        run: |
          strip target/x86_64-unknown-linux-gnu/release/fish_11_cli
          tar -czvf fish_11_cli-linux-x86_64.tar.gz -C target/x86_64-unknown-linux-gnu/release fish_11_cli

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fish_11_cli-linux-x86_64
          path: fish_11_cli-linux-x86_64.tar.gz

  # --- Job pour compiler sur Windows ---
  build-windows:
    name: Build for Windows (i686)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: i686-pc-windows-msvc

      - name: Build fish_11_cli
        run: cargo build --release --target x86_64-unknown-linux-gnu -p fish_11_cli

      - name: Prepare release artifacts
        run: |
          mkdir -p release
          cp target/x86_64-unknown-linux-gnu/release/fish_11_cli release/
          strip release/fish_11_cli
          cp README.md release/
          cp LICENSE release/
          
          # Create installation instructions
          cat > release/INSTALL.txt << 'EOF'
          FiSH_11 CLI Tool for Linux
          ==========================

          This is the command-line tool for testing FiSH_11 encryption/decryption.

          Usage:
            ./fish_11_cli --help

          Version: ${{ github.ref_name }}
          Build date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          tar -czvf fish_11_cli-linux-x86_64.tar.gz -C release .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fish_11_cli-windows-i686
          path: fish_11_cli-windows-i686.zip

  # --- Job pour crÃ©er la Release ---
  create-release:
    name: Create GitHub Release (Draft)
    runs-on: ubuntu-latest
    needs: [build-windows-i686, build-linux-x64]
    permissions:
      contents: write # NÃ©cessaire pour crÃ©er une release
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: fish_11_cli-linux-x86_64
          path: artifacts

      - name: List artifacts
        run: ls -lR artifacts

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## FiSH_11 Release ${{ steps.get_version.outputs.VERSION }}

          ### What's New
          - Secure IRC encryption using X25519 key exchange
          - ChaCha20-Poly1305 authenticated encryption
          - FCEP-1 channel encryption protocol support
          - Automatic key rotation with configurable TTL
          - Network-aware key management

          ### Downloads
          - **Windows (mIRC)**: `fish_11-windows-i686.zip` - Complete package with DLLs and mIRC script
          - **Linux (CLI)**: `fish_11_cli-linux-x86_64.tar.gz` - Command-line tool for testing

          ### Installation (Windows/mIRC)
          1. Extract `fish_11-windows-i686.zip` to your mIRC directory
          2. Load the script: `/load -rs fish_11.mrc`
          3. Start using encryption: `/fish11_X25519_INIT nickname`

          ### Documentation
          - See `README.md` for full documentation
          - See `INSTALL.txt` for installation instructions
          - See `docs/` folder for API reference and usage examples

          ### Security Notes
          - Always verify key fingerprints through a secure out-of-band channel
          - Keys exchanged via DH expire after 24 hours by default (configurable)
          - Manual keys never expire unless explicitly removed

          Built on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          EOF

      - name: Create GitHub Release (Draft)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/fish_11-windows-i686/fish_11-windows-i686.zip
            artifacts/fish_11_cli-linux-x86_64/fish_11_cli-linux-x86_64.tar.gz
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display upload instructions
        run: |
          echo "::notice::âœ… Release draft created at: https://github.com/${{ github.repository }}/releases"
          echo "::notice::ðŸ“¦ Upload Windows i686 binaries using: .\scripts\upload-release-assets.ps1 -Version ${{ steps.get_version.outputs.VERSION }}"
