name: Create Release

on:
  push:
    tags:
      - 'v*.*.*' # Se dÃ©clenche sur les tags comme v1.0.0, v1.2.3, etc.
  workflow_dispatch: # Permet de dÃ©clencher manuellement

env:
  CARGO_TERM_COLOR: always

jobs:
  # --- Job pour compiler sur Windows (i686 pour mIRC 32-bit) ---
  build-windows-i686:
    name: Build Windows DLLs (i686)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: i686-pc-windows-msvc

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-i686-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build fish_11.dll (core)
        run: cargo build --release --target i686-pc-windows-msvc -p fish_11_dll

      - name: Build fish_11_inject.dll
        run: cargo build --release --target i686-pc-windows-msvc -p fish_11_inject

      - name: Build fish_11_cli.exe
        run: cargo build --release --target i686-pc-windows-msvc -p fish_11_cli

      - name: Prepare release package
        shell: pwsh
        run: |
          # Create release directory
          New-Item -ItemType Directory -Force -Path release

          # Copy DLLs
          Copy-Item target/i686-pc-windows-msvc/release/fish_11.dll release/
          Copy-Item target/i686-pc-windows-msvc/release/fish_11_inject.dll release/

          # Copy CLI tool
          Copy-Item target/i686-pc-windows-msvc/release/fish_11_cli.exe release/

          # Copy mIRC script
          Copy-Item scripts/mirc/fish_11.mrc release/

          # Copy documentation
          Copy-Item README.md release/
          Copy-Item LICENSE release/
          if (Test-Path "docs/INSTALLATION.md") {
            Copy-Item docs/INSTALLATION.md release/
          }

          # Create INI template
          @"
          [fish11]
          encrypt_notice=false
          encrypt_action=false
          process_incoming=true
          process_outgoing=true
          mark_encrypted= 12$$chr(183)
          no_fish10_legacy=false
          plain_prefix=+p 
          mark_position=1
          "@ | Out-File -FilePath release/fish_11.ini -Encoding ASCII

          # Create installation instructions
          @"
          FiSH_11 Installation Instructions
          ==================================

          1. Copy fish_11.dll and fish_11_inject.dll to your mIRC directory
          2. Copy fish_11.mrc to your mIRC scripts folder
          3. Load the script in mIRC: /load -rs fish_11.mrc
          4. The DLLs will be loaded automatically on startup

          For detailed documentation, see README.md and INSTALLATION.md

          Files included:
          - fish_11.dll (core cryptographic library)
          - fish_11_inject.dll (network injection hooks)
          - fish_11.mrc (mIRC script interface)
          - fish_11_cli.exe (command-line testing tool)
          - fish_11.ini (configuration template)

          Version: ${{ github.ref_name }}
          Build date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
          "@ | Out-File -FilePath release/INSTALL.txt -Encoding UTF8

          # Create archive
          Compress-Archive -Path release/* -DestinationPath fish_11-windows-i686.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fish_11-windows-i686
          path: fish_11-windows-i686.zip
          retention-days: 7

  # --- Job pour compiler sur Linux (x86_64 pour CLI) ---
  build-linux-x64:
    name: Build Linux CLI (x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-x64-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build fish_11_cli
        run: cargo build --release --target x86_64-unknown-linux-gnu -p fish_11_cli

      - name: Prepare release package
        run: |
          mkdir -p release
          cp target/x86_64-unknown-linux-gnu/release/fish_11_cli release/
          strip release/fish_11_cli
          cp README.md release/
          cp LICENSE release/
          
          # Create installation instructions
          cat > release/INSTALL.txt << 'EOF'
          FiSH_11 CLI Tool for Linux
          ==========================

          This is the command-line tool for testing FiSH_11 encryption/decryption.

          Usage:
            ./fish_11_cli --help

          Version: ${{ github.ref_name }}
          Build date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          tar -czvf fish_11_cli-linux-x86_64.tar.gz -C release .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fish_11_cli-linux-x86_64
          path: fish_11_cli-linux-x86_64.tar.gz
          retention-days: 7

  # --- Job pour crÃ©er la Release GitHub ---
  create-release:
    name: Create GitHub Release (Draft)
    runs-on: ubuntu-latest
    needs: [build-windows-i686, build-linux-x64]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: fish_11_cli-linux-x86_64
          path: artifacts

      - name: List artifacts
        run: ls -lR artifacts

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## FiSH_11 Release ${{ steps.get_version.outputs.VERSION }}

          ### What's New
          - Secure IRC encryption using X25519 key exchange
          - ChaCha20-Poly1305 authenticated encryption
          - FCEP-1 channel encryption protocol support
          - Automatic key rotation with configurable TTL
          - Network-aware key management

          ### Downloads
          - **Windows (mIRC)**: `fish_11-windows-i686.zip` - Complete package with DLLs and mIRC script
          - **Linux (CLI)**: `fish_11_cli-linux-x86_64.tar.gz` - Command-line tool for testing

          ### Installation (Windows/mIRC)
          1. Extract `fish_11-windows-i686.zip` to your mIRC directory
          2. Load the script: `/load -rs fish_11.mrc`
          3. Start using encryption: `/fish11_X25519_INIT nickname`

          ### Documentation
          - See `README.md` for full documentation
          - See `INSTALL.txt` for installation instructions
          - See `docs/` folder for API reference and usage examples

          ### Security Notes
          - Always verify key fingerprints through a secure out-of-band channel
          - Keys exchanged via DH expire after 24 hours by default (configurable)
          - Manual keys never expire unless explicitly removed

          Built on: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Commit: ${{ github.sha }}
          EOF

      - name: Create GitHub Release (Draft)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/fish_11-windows-i686/fish_11-windows-i686.zip
            artifacts/fish_11_cli-linux-x86_64/fish_11_cli-linux-x86_64.tar.gz
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display upload instructions
        run: |
          echo "::notice::âœ… Release draft created at: https://github.com/${{ github.repository }}/releases"
          echo "::notice::ðŸ“¦ Upload Windows i686 binaries using: .\scripts\upload-release-assets.ps1 -Version ${{ steps.get_version.outputs.VERSION }}"
