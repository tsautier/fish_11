name: Build Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [closed]  # Trigger when PR is closed/merged

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: self-hosted
    permissions:
      contents: write
    strategy:
      matrix:
        target: [i686-pc-windows-msvc]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: false  # Désactive le checkout des submodules pour éviter les erreurs
    
    - name: Install Rust toolchain for ${{ matrix.target }}
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        override: true
        components: rust-src
    
    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ matrix.target }}
        shared-key: "rust-cache"
        cache-targets: true
        cache-on-failure: true
      
    - name: Build fish_11 CLI (Release)
      run: cargo build --release --package fish_11_cli --target ${{ matrix.target }}
          
    - name: Build fish_11 DLL library (Release)
      run: cargo build --release --package fish_11 --target ${{ matrix.target }}

    - name: Build fish_11 injection DLL (Release)
      run: cargo build --release --package fish_11_inject --target ${{ matrix.target }}
    
    # Build Debug variants as well
    - name: Build fish_11 CLI (Debug)
      run: cargo build --package fish_11_cli --target ${{ matrix.target }}

    - name: Build fish_11 DLL library (Debug)
      run: cargo build --package fish_11 --target ${{ matrix.target }}

    - name: Build fish_11 injection DLL (Debug)
      run: cargo build --package fish_11_inject --target ${{ matrix.target }}

    # Tests temporarily disabled due to file access issues in CI
    # - name: Run tests
    #   run: cargo test --workspace --target ${{ matrix.target }}
    
    - name: Extract version from compiled binary
      id: version
      run: |
        # execute fish_11_cli.exe to get version output
        $OUTPUT = & "target\${{ matrix.target }}\release\fish_11_cli.exe" --version 2>&1
        Write-Host "CLI output: $OUTPUT"

        # Parser la sortie pour extraire version et build
        # Format attendu: "FiSH_11_cli X.X.X (build NNNN or NNNN-release)"
        if ($OUTPUT -match "FiSH_11_cli\s+(\S+)\s+\(build\s+(\S+)\)") {
          $VERSION = $matches[1]
          $BUILD = $matches[2]
          # remove optional '-release' suffix from build string
          $BUILD_CLEAN = $BUILD -replace '-release$',''
          Write-Host "Extracted - Version: $VERSION, Build: $BUILD (clean: $BUILD_CLEAN)"
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          echo "build_number=$BUILD_CLEAN" >> $env:GITHUB_OUTPUT
          echo "full_version=$VERSION-$BUILD_CLEAN" >> $env:GITHUB_OUTPUT
        } else {
          # Fallback si le parsing échoue
          Write-Host "Warning: Could not parse version, using fallback"
          $VERSION = "unknown"
          $BUILD = "${{ github.run_number }}"
          $BUILD_CLEAN = $BUILD -replace '-release$',''
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          echo "build_number=$BUILD_CLEAN" >> $env:GITHUB_OUTPUT
          echo "full_version=$VERSION-build$BUILD_CLEAN" >> $env:GITHUB_OUTPUT
        }
      shell: powershell
    
    - name: Create release package
      run: |
        Write-Host "Creating release package directory..."
        New-Item -ItemType Directory -Force -Path release_package | Out-Null
        
        Write-Host "Copying binaries..."
        Copy-Item "target\${{ matrix.target }}\release\fish_11_cli.exe" -Destination "release_package\"
        Copy-Item "target\${{ matrix.target }}\release\fish_11.dll" -Destination "release_package\"
        Copy-Item "target\${{ matrix.target }}\release\fish_11_inject.dll" -Destination "release_package\"
        # also include Debug builds (renamed to avoid overwrite)
        if (Test-Path "target\${{ matrix.target }}\debug\fish_11_cli.exe") {
          Copy-Item "target\${{ matrix.target }}\debug\fish_11_cli.exe" -Destination "release_package\fish_11_cli_debug.exe"
        }
        if (Test-Path "target\${{ matrix.target }}\debug\fish_11.dll") {
          Copy-Item "target\${{ matrix.target }}\debug\fish_11.dll" -Destination "release_package\fish_11_debug.dll"
        }
        if (Test-Path "target\${{ matrix.target }}\debug\fish_11_inject.dll") {
          Copy-Item "target\${{ matrix.target }}\debug\fish_11_inject.dll" -Destination "release_package\fish_11_inject_debug.dll"
        }
        
        Write-Host "Copying documentation files..."
        if (Test-Path "README.md") {
          Copy-Item "README.md" -Destination "release_package\"
        } else {
          Write-Host "No README.md found"
        }
        
        if (Test-Path "LICENSE") {
          Copy-Item "LICENSE" -Destination "release_package\"
        } else {
          Write-Host "No LICENSE found"
        }
        
        Write-Host "Creating VERSION.txt..."
        "FiSH_11 Version ${{ steps.version.outputs.full_version }}" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8
        "Build Number: ${{ steps.version.outputs.build_number }}" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "Target: ${{ matrix.target }}" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "Compiled: ${{ github.event.head_commit.timestamp }}" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "Commit: ${{ github.sha }}" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "Branch: ${{ github.ref_name }}" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "Files included:" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "- fish_11_cli.exe       : Command-line interface" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "- fish_11.dll           : Main FiSH encryption DLL" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "- fish_11_inject.dll    : Injection DLL for mIRC" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "- fish_11_cli_debug.exe : CLI debug binary" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "- fish_11_debug.dll     : DLL debug binary" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        "- fish_11_inject_debug.dll : Injection DLL debug binary" | Out-File -FilePath "release_package\VERSION.txt" -Encoding utf8 -Append
        
        Write-Host "Release package created successfully"
        Get-ChildItem -Path "release_package"
      shell: powershell
    
    - name: Create ZIP archive
      id: zip
      run: |
        $ZIP_NAME = "fish_11-${{ steps.version.outputs.full_version }}-${{ matrix.target }}.zip"
        Write-Host "Creating ZIP: $ZIP_NAME"
        Compress-Archive -Path "release_package\*" -DestinationPath $ZIP_NAME -Force
        
        # Vérifier la taille du ZIP
        $zipSize = (Get-Item $ZIP_NAME).Length
        Write-Host "ZIP created successfully - Size: $([math]::Round($zipSize/1KB, 2)) KB"
        
        echo "zip_name=$ZIP_NAME" >> $env:GITHUB_OUTPUT
      shell: powershell
    
    - name: Upload complete package
      uses: actions/upload-artifact@v4
      with:
        name: fish_11-complete-${{ steps.version.outputs.full_version }}-${{ matrix.target }}
        path: ${{ steps.zip.outputs.zip_name }}
    
    # Generate release notes summary when pushing to main (after merge)
    - name: Generate Release Notes Summary
      id: release_notes
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # Check if GitHub CLI is available, install if not
        if (!(Get-Command gh -ErrorAction SilentlyContinue)) {
          Write-Host "Installing GitHub CLI..."
          try {
            winget install GitHub.cli
          } catch {
            Write-Host "Could not install GitHub CLI: $_"
          }
        }

        # Récupère les tags existants qui correspondent au format spécifique
        $tags = $(git tag --list --sort=-v:refname 2>$null)
        $lastTag = $null

        if ($tags) {
          # Trier les tags et trouver le dernier qui correspond au format attendu (ex: 11.25.0-20251216195555)
          $sortedTags = $tags -split "`n" | Where-Object { $_ -match '^\d+\.\d+\.\d+-\d+$' } | Sort-Object { [version]$_.Split('-')[0] } -Descending
          if ($sortedTags) {
            $lastTag = $sortedTags[0]
          }
        }

        if ([string]::IsNullOrEmpty($lastTag)) {
          # Si aucun tag approprié n'est trouvé, utilise les derniers commits
          Write-Host "No matching tags found in format X.Y.Z-YYYYMMDDHHMMSS, using recent commits"
          $commits = $(git log --oneline --no-merges --first-parent -10 2>$null)
        } else {
          Write-Host "Using tag: $lastTag"
          # Utilise les commits depuis le dernier tag approprié
          $commits = $(git log --oneline --no-merges --first-parent $lastTag..HEAD 2>$null)
        }

        # Récupère les pull requests fusionnés récemment
        try {
          $prs = gh pr list --state merged --limit 20 --json number,title,author,labels,milestone --jq '.[] | "- PR #\(.number): \(.title) by \(.author.login)"' 2>$null
        } catch {
          Write-Host "Could not fetch pull requests: $_"
          $prs = $null
        }

        # Génère un résumé des fonctionnalités basé sur les messages de commit
        $features = ""
        $fixes = ""

        if ($commits) {
          foreach ($commit in ($commits -split "`n")) {
            if ($commit -and $commit -match "(feat|feature|add|implement)" -and $commit -notmatch "fix|bug|refactor|docs|test|chore") {
              $features += "`n- $commit"
            } elseif ($commit -and $commit -match "(fix|bug|resolve)" -and $commit -notmatch "feat|feature|add|implement") {
              $fixes += "`n- $commit"
            }
          }
        }

        # Crée le corps des notes de version
        $body = "**FiSH_11 Release Summary**`n`n"

        $body += "### Features:`n"
        if ($features) {
          $body += $features.Trim()
        } else {
          $body += "- No new features in this release"
        }

        $body += "`n`n### Bug fixes:`n"
        if ($fixes) {
          $body += $fixes.Trim()
        } else {
          $body += "- No bug fixes in this release"
        }

        $body += "`n`n### Pull requests merged:`n"
        if ($prs) {
          $body += $prs
        } else {
          $body += "- No pull requests merged in this release"
        }

        $body += "`n`n### Build information`n"
        $body += "- **Commit**: ${{ github.sha }}`n"
        $body += "- **Date**: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")`n`n"

        # Write the body to a file and set as output
        $body | Out-File -FilePath "release_summary.txt" -Encoding utf8
        $body = $body -replace '"', '\"'  # Escape quotes for JSON
        echo "body=$($body -replace "`n", "%0A")" >> $env:GITHUB_OUTPUT
      shell: powershell

    # Only upload to GitHub Release when triggered by release event (manual creation)
    - name: Upload to GitHub Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.zip.outputs.zip_name }}
        name: ${{ steps.version.outputs.full_version }}
        body: ${{ steps.release_notes.outputs.body }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Print release summary when pushing to main branch (after merge)
    - name: Print Release Summary
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        Write-Host "==========================================" -ForegroundColor Green
        Write-Host "Release summary generated:" -ForegroundColor Green
        Write-Host "==========================================" -ForegroundColor Green
        if (Test-Path "release_summary.txt") {
          Get-Content "release_summary.txt"
        } else {
          Write-Host "No release summary generated."
        }
        Write-Host "==========================================" -ForegroundColor Green
      shell: powershell