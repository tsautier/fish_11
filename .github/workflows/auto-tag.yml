name: Auto Tag on Merge

on:
  push:
    branches: [ main ]

jobs:
  auto-tag:
    name: Create Tag Automatically
    runs-on: self-hosted
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: false

    - name: Extract version and create tag
      run: |
        $ErrorActionPreference = "Continue"
        
        # Fallback identique à build.yml : lire Cargo.toml + timestamp
        try {
          $VERSION = (Get-Content Cargo.toml | Select-String 'version = "(.+)"' | Select-Object -First 1).Matches.Groups[1].Value
        } catch {
          $VERSION = "unknown"
        }
        $BUILD = Get-Date -Format "yyyyMMddHHmmss"
        
        $tagName = "v$VERSION-$BUILD"
        Write-Host "Creating tag: $tagName"
        
        # Vérifie si le tag existe déjà
        $existingTag = git tag -l $tagName
        if ($existingTag) {
          Write-Host "Tag $tagName already exists, skipping"
          exit 0
        }
        
        # Configure Git et crée le tag
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a $tagName -m "Auto-tagged release $tagName from merge to main"
        git push origin $tagName
        
        Write-Host "Tag $tagName created and pushed successfully"
      shell: powershell
